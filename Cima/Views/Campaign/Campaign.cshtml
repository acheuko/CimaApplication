@{
    ViewBag.Title = "Campagne";
    Culture = "fr-FR";
}

<h2>Liste des Campagnes</h2>

<div class="row">

    <div id="campaigntable" style="width:100%; ">

      


    </div>

</div>

<div class="row" style="margin-top:20px">

    <div class="demo-section k-header" style="width:700px;padding:20px">

        <div class="form-component">
            <label for="start">Date de début:</label><input id="start" style="width: 200px" value="10/10/2025" />
        </div>

        <div class="form-component">
            <label for="end">Date de fin:</label><input id="end" style="width: 200px" value="10/10/2026" />
        </div>

        <div class="form-component row">
            <div class="subject-info-box-1">
                Fichiers Disponibles
                <select multiple="multiple" id='lstBox1' class="form-control">
                    @foreach (var m in ViewBag.CampaignFiles)
                    {

                        <option value=@m.CampaignFileId> @m.CampaignFileName</option>

                    }
                </select>
            </div>

            <div class="subject-info-arrows text-center">
                <input type='button' id='btnAllRight' value='>>' class="btn btn-default" /><br />
                <input type='button' id='btnRight' value='>' class="btn btn-default" /><br />
                <input type='button' id='btnLeft' value='<' class="btn btn-default" /><br />
                <input type='button' id='btnAllLeft' value='<<' class="btn btn-default" />
            </div>

            <div class="subject-info-box-2">
                Fichiers Sélectionnés
                <select multiple="multiple" id='lstBox2' class="form-control">
                </select>
            </div>
        </div>



        <div class="form-component" style="clear:both">
            <label>Controle à activer</label>
            <div>

                <input class="chkbox-control" type="checkbox" name="exhaustivite" value="E"> Exhaustivité<br>
                <div id="rb-exhaustivite" style="display:none">
                    <label><input type="radio" name="optexhaustivite" value="Y"> Bloquant</label>
                    <label><input type="radio" name="optexhaustivite" value="N"> Non bloquant</label>
                </div>
                <input class="chkbox-control" type="checkbox" name="conformite" value="CF"> Conformité<br>
                <div id="rb-conformite" style="display:none">
                    <label><input type="radio" name="optconformite" value="Y"> Bloquant</label>
                    <label><input type="radio" name="optconformite" value="N"> Non bloquant</label>
                </div>
                <input class="chkbox-control" type="checkbox" name="coherence" value="CH"> Cohérence<br>
                <div id="rb-coherence" style="display:none">
                    <label><input type="radio" name="optcoherence" value="Y"> Bloquant</label>
                    <label><input type="radio" name="optcoherence" value="N"> Non bloquant</label>
                </div>
            </div>
        </div>

        <div id="bt-submit" class="row form-component" style="padding:15px;float:right">
            <p>
                <kendo-button class="btn-success k-button" onclick="saveCampaign()" style="color:white;font-weight:bold"><span>Enregistrer</span>  <i class="upload-spinner fa fa-spinner fa-pulse fa-3x fa-fw" style="font-size:1em;display:none"></i></kendo-button>
                <kendo-button id="bt-cancel" class="btn-warning k-button" onclick="cancel()" style="color:darkorange;font-weight:bold">Annuler <i class="cancel-spinner fa fa-spinner fa-pulse fa-3x fa-fw" style="font-size:1em;display:none"></i></kendo-button>
            </p>
        </div>

        <span id="notification" style="display:none;"></span>


        <script id="successTemplate" type="text/x-kendo-template">
            <div class="upload-success">
                <img src="../../Images/success-icon.png" />
                <h3>#= message #</h3>
            </div>
        </script>

    </div>
    <script>
        $(document).ready(function () {

            //set culture of the Kendo UI
            kendo.culture("fr-FR");

            function startChange() {
                var startDate = start.value(),
                    endDate = end.value();

                if (startDate) {
                    startDate = new Date(startDate);
                    startDate.setDate(startDate.getDate());
                    end.min(startDate);
                } else if (endDate) {
                    start.max(new Date(endDate));
                } else {
                    endDate = new Date();
                    start.max(endDate);
                    end.min(endDate);
                }
            }

            function endChange() {
                var endDate = end.value(),
                    startDate = start.value();

                if (endDate) {
                    endDate = new Date(endDate);
                    endDate.setDate(endDate.getDate());
                    start.max(endDate);
                } else if (startDate) {
                    end.min(new Date(startDate));
                } else {
                    endDate = new Date();
                    start.max(endDate);
                    end.min(endDate);
                }
            }

            var start = $("#start").kendoDatePicker({
                change: startChange
            }).data("kendoDatePicker");

            var end = $("#end").kendoDatePicker({
                change: endChange
            }).data("kendoDatePicker");

            start.max(end.value());
            end.min(start.value());
        });

        $('.chkbox-control').change(function() {
            // this will contain a reference to the checkbox   
            if (this.checked) {
                // the checkbox is now checked
                //$("#rb-exhaustivite").slideDown();
                $(this).next().next().slideDown();
            } else {
                // the checkbox is now no longer checked
                //$("#rb-exhaustivite").slideUp();
                 $(this).next().next().slideUp();
            }
        });

        // fonction qui permet d'enregistrer une campagne
        function saveCampaign() {
            var datedeb = $("#start").val();
            var datefin = $("#end").val();
            var selectedCampaignFiles = $("#lstBox2 option");
            var optexhaustivite = $("input[name='optexhaustivite']:checked").val() == null? 'N': $("input[name='optexhaustivite']:checked").val();
            var optcoherence = $("input[name='optcoherence']:checked").val() == null ? 'N': $("input[name='optcoherence']:checked").val();
            var optconformite = $("input[name='optconformite']:checked").val() == null ? 'N' : $("input[name='optconformite']:checked").val();

            var notification = $("#notification").kendoNotification({
                position: {
                    pinned: true,
                    top: 30,
                    right: 30
                },
                autoHideAfter: 3000,
                stacking: "down",
                templates: [{
                    type: "upload-success",
                    template: $("#successTemplate").html()
                }]
            }).data("kendoNotification");

            if (selectedCampaignFiles.length == 0) {

                alert('Aucun fichier selectionné pour la campagne à créer');
                //e.preventDefault();
            }

            var selectedCampaignFilesId = [];

            $.map(selectedCampaignFiles, function (option) {
                return selectedCampaignFilesId.push(option.value);
            });

            var selectedCampaingControlsId = [];
            /* look for all checkboes that have a class 'chkbox-control' attached to it and check if it was checked */
	        $(".chkbox-control:checked").each(function() {
		        selectedCampaingControlsId.push($(this).val());
	        });

            $.ajax({
                type: 'POST',
                url: '/Campaign/CreateCampaign',
                data: JSON.stringify({ datedeb: datedeb, datefin: datefin, selectedCampaignFiles: selectedCampaignFilesId, selectedCampaingControls: selectedCampaingControlsId, optexhaustivite: optexhaustivite, optcoherence: optcoherence, optconformite:optconformite }),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (response) {
                    //$(".file-upload-progress").slideUp();
                    if (response != null) {
                        console.log("campagne enregistré avec succès");

                            notification.show({
                            message: "Campagne créee"
                            }, "upload-success");

                        // Réinitialiser la listBox 2
                        $("#lstBox2 option").remove();
                        // Réinitialiser la listBox 1
                        initListBox1(response);
                    }
                    else {
                        console.log("echec enregistrement privileges");
                    }

                },
                failure: function (response) {
                    alert("erreur opération d'enregistrement");
                }
            });
        }

        function initListBox1(listItems) {
            $("#lstBox1 option").remove();
            $.map(listItems, function (option) {
                $("#lstBox1").append('<option value="' + option.MenuId + '">' + option.Name + '</option>');
            });
        }

        (function () {
            $('#btnRight').click(function (e) {
                var selectedOpts = $('#lstBox1 option:selected');
                if (selectedOpts.length == 0) {
                    alert("Nothing to move.");
                    e.preventDefault();
                }

                $('#lstBox2').append($(selectedOpts).clone());
                $(selectedOpts).remove();

                /* -- Uncomment for optional sorting --
                var box2Options = $('#lstBox2 option');
                var box2OptionsSorted;
                box2OptionsSorted = box2Options.toArray().sort(strDes);
                $('#lstBox2').empty();
                box2OptionsSorted.forEach(function(opt){
                  $('#lstBox2').append(opt);
                })
                */

                e.preventDefault();
            });

            $('#btnAllRight').click(function (e) {
                var selectedOpts = $('#lstBox1 option');
                if (selectedOpts.length == 0) {
                    alert("Nothing to move.");
                    e.preventDefault();
                }

                $('#lstBox2').append($(selectedOpts).clone());
                $(selectedOpts).remove();
                e.preventDefault();
            });

            $('#btnLeft').click(function (e) {
                var selectedOpts = $('#lstBox2 option:selected');
                if (selectedOpts.length == 0) {
                    alert("Nothing to move.");
                    e.preventDefault();
                }

                $('#lstBox1').append($(selectedOpts).clone());
                $(selectedOpts).remove();
                e.preventDefault();
            });

            $('#btnAllLeft').click(function (e) {
                var selectedOpts = $('#lstBox2 option');
                if (selectedOpts.length == 0) {
                    alert("Nothing to move.");
                    e.preventDefault();
                }

                $('#lstBox1').append($(selectedOpts).clone());
                $(selectedOpts).remove();
                e.preventDefault();
            });
        }(jQuery));

    </script>

    <style scoped>
       

            .demo-section .form-component {
                margin-top: 1em;
            }

            .demo-section label {
                display: inline-block;
                width: 120px;
                padding-right: 5px;
                text-align: right;
            }

        #example .k-datepicker {
            vertical-align: middle;
        }

        #example h3 {
            clear: both;
        }

        #example .code-sample {
            width: 60%;
            float: left;
            margin-bottom: 20px;
        }

        #example .output {
            width: 24%;
            margin-left: 4%;
            float: left;
        }


         .subject-info-box-1,
        .subject-info-box-2 {
            float: left;
            width: 45%;
        }

            .subject-info-box-1 select,
            .subject-info-box-2 select {
                height: 200px;
                padding: 0;
            }

                .subject-info-box-1 select option,
                .subject-info-box-2 select option {
                    padding: 4px 10px 4px 10px;
                }


                    .subject-info-box-1 select option:hover,
                    .subject-info-box-2 select option:hover {
                        background: #EEEEEE;
                    }

        .selectedOption {
            background: #ccc;
        }


        .subject-info-arrows {
            float: left;
            width: 10%;
            margin-top: 30px;
        }

            .subject-info-arrows input {
                width: 70%;
                margin-bottom: 5px;
            }

    </style>


</div>

